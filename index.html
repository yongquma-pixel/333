<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>è·¯åŒºé€š - æé€Ÿç‰ˆ</title>
    
    <script>
        window.onerror = function(msg, url, line) {
            document.getElementById('error-log').innerHTML += 
                '<p style="color:red">âŒ Error: ' + msg + '<br>Line: ' + line + '</p>';
            document.getElementById('loading').style.display = 'none';
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 12px; color: #9ca3af; }
        .nav-item.active { color: #2563eb; }
        /* åŠ è½½åŠ¨ç”» */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script src="https://cdn.staticfile.org/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.staticfile.org/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.org/react-router-dom/6.3.0/react-router-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.org/babel-standalone/7.22.20/babel.min.js"></script>
    <script src="https://cdn.staticfile.org/idb/7.1.1/idb.min.js"></script>
</head>
<body class="bg-gray-50">
    
    <div id="loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="spinner"></div>
        <p class="text-gray-500 font-bold">æ­£åœ¨å¯åŠ¨è·¯åŒºé€š...</p>
        <div id="error-log" class="mt-4 text-xs text-left px-4"></div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // 1. åˆå§‹åŒ– React
        const { useState, useEffect, useMemo } = React;
        const { HashRouter, Routes, Route, Link, useLocation, useNavigate, Navigate } = ReactRouterDOM;

        // 2. æ•°æ®åº“æœåŠ¡ (ç®€ç‰ˆ)
        const DB_NAME = 'courier_app_v1';
        const dbService = {
            async init() {
                this.db = await idb.openDB(DB_NAME, 1, {
                    upgrade(db) { if (!db.objectStoreNames.contains('streets')) db.createObjectStore('streets', { keyPath: 'id' }); }
                });
            },
            async getAll() { await this.init(); return this.db.getAll('streets'); },
            async add(data) { 
                await this.init(); 
                await this.db.add('streets', { ...data, id: Date.now().toString() }); 
            },
            async delete(id) { await this.init(); await this.db.delete('streets', id); },
            async search(kw) {
                await this.init();
                const all = await this.db.getAll('streets');
                if (!kw) return [];
                return all.filter(s => s.streetName.includes(kw) || s.routeArea.includes(kw));
            }
        };

        // 3. å¸ƒå±€ç»„ä»¶
        const Layout = ({ children }) => {
            const location = useLocation();
            // å…³é—­åŠ è½½åŠ¨ç”»
            useEffect(() => { document.getElementById('loading').style.display = 'none'; }, []);

            return (
                <div className="min-h-screen flex flex-col max-w-md mx-auto bg-white shadow-xl">
                    <header className="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md sticky top-0 z-10">
                        <span className="text-lg font-bold flex items-center">ğŸ“¦ è·¯åŒºé€š</span>
                        <span className="text-xs bg-blue-700 px-2 py-1 rounded">V2.0 æé€Ÿç‰ˆ</span>
                    </header>
                    <main className="flex-1 overflow-y-auto p-4 pb-20 bg-gray-50">
                        {children}
                    </main>
                    <nav className="fixed bottom-0 w-full max-w-md bg-white border-t flex justify-around py-3 pb-6 z-20 shadow-up">
                        <Link to="/" className={`nav-item ${location.pathname === '/' ? 'active' : ''}`}>
                            <span className="text-xl">ğŸ </span>
                            <span>é¦–é¡µ</span>
                        </Link>
                        <Link to="/search" className={`nav-item ${location.pathname === '/search' ? 'active' : ''}`}>
                            <span className="text-xl">ğŸ”</span>
                            <span>æŸ¥è¯¢</span>
                        </Link>
                        <Link to="/manage" className={`nav-item ${location.pathname === '/manage' ? 'active' : ''}`}>
                            <span className="text-xl">âš™ï¸</span>
                            <span>ç®¡ç†</span>
                        </Link>
                    </nav>
                </div>
            );
        };

        // 4. é¡µé¢ç»„ä»¶
        const HomePage = () => {
            const [count, setCount] = useState(0);
            useEffect(() => { dbService.getAll().then(res => setCount(res.length)); }, []);

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="bg-blue-100 p-6 rounded-2xl text-blue-800">
                        <h1 className="text-2xl font-bold mb-2">ğŸ‘‹ ä½ å¥½ï¼Œåˆ†æ‹£å‘˜</h1>
                        <p className="text-sm opacity-80">å½“å‰å·²æ”¶å½• <b>{count}</b> æ¡è·¯åŒºä¿¡æ¯</p>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <Link to="/search" className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center space-y-2 active:scale-95 transition-transform">
                            <span className="text-3xl">ğŸ¤</span>
                            <span className="font-bold text-gray-700">æŸ¥è·¯åŒº</span>
                        </Link>
                        <Link to="/manage" className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center space-y-2 active:scale-95 transition-transform">
                            <span className="text-3xl">ğŸ“</span>
                            <span className="font-bold text-gray-700">å½•å…¥æ•°æ®</span>
                        </Link>
                    </div>
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-500 text-sm mb-2">ğŸ“Œ ä½¿ç”¨è´´å£«</h3>
                        <p className="text-xs text-gray-400">ç‚¹å‡»â€œç®¡ç†â€å¯ä»¥æ‰‹åŠ¨æ·»åŠ è·¯åŒºï¼Œæˆ–è€…å¯¼å…¥Excelã€‚æ•°æ®å‡ä¿å­˜åœ¨æœ¬åœ°æ‰‹æœºä¸­ã€‚</p>
                    </div>
                </div>
            );
        };

        const ManagePage = () => {
            const [list, setList] = useState([]);
            const [form, setForm] = useState({ streetName: '', routeArea: '' });
            
            const load = () => dbService.getAll().then(setList);
            useEffect(() => { load(); }, []);

            const handleAdd = async () => {
                if (!form.streetName || !form.routeArea) return alert("è¯·å¡«å†™å®Œæ•´ï¼");
                await dbService.add(form);
                setForm({ streetName: '', routeArea: '' });
                load();
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-5 rounded-2xl shadow-sm">
                        <h2 className="font-bold mb-4">â• æ·»åŠ æ–°è·¯åŒº</h2>
                        <div className="space-y-3">
                            <input className="w-full p-3 border rounded-xl bg-gray-50" placeholder="è¡—é“/å°åŒºå (å¦‚: å¹¸ç¦è·¯)" value={form.streetName} onChange={e => setForm({...form, streetName: e.target.value})} />
                            <input className="w-full p-3 border rounded-xl bg-gray-50" placeholder="è·¯åŒºå· (å¦‚: A-01)" value={form.routeArea} onChange={e => setForm({...form, routeArea: e.target.value})} />
                            <button onClick={handleAdd} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:bg-blue-700">ç¡®è®¤ä¿å­˜</button>
                        </div>
                    </div>
                    <div className="space-y-3">
                        <h3 className="font-bold text-gray-500 ml-1">ğŸ“š å·²æ”¶å½• ({list.length})</h3>
                        {list.map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-100">
                                <div>
                                    <div className="font-bold text-gray-800">{item.streetName}</div>
                                    <div className="text-xs text-blue-500 font-mono mt-1">{item.routeArea}</div>
                                </div>
                                <button onClick={async () => { if(confirm('ç¡®è®¤åˆ é™¤?')) { await dbService.delete(item.id); load(); } }} className="text-gray-300 px-2">âœ•</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SearchPage = () => {
            const [val, setVal] = useState('');
            const [res, setRes] = useState([]);
            
            const handleSearch = (txt) => {
                setVal(txt);
                dbService.search(txt).then(setRes);
            };

            return (
                <div className="space-y-4">
                    <div className="sticky top-0 bg-gray-50 pt-2 pb-2 z-10">
                        <input className="w-full p-4 rounded-2xl shadow-sm border-none outline-none ring-2 ring-blue-100 focus:ring-blue-500 transition-all" placeholder="è¾“å…¥è·¯åå¿«é€ŸæŸ¥æ‰¾..." value={val} onChange={e => handleSearch(e.target.value)} />
                    </div>
                    <div className="space-y-2">
                        {res.map(item => (
                            <div key={item.id} className="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                                <span className="font-bold text-lg">{item.streetName}</span>
                                <span className="text-xl font-black text-blue-600">{item.routeArea}</span>
                            </div>
                        ))}
                        {val && res.length === 0 && <div className="text-center text-gray-400 py-10">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</div>}
                    </div>
                </div>
            );
        };

        // 5. è·¯ç”±å…¥å£
        const App = () => (
            <HashRouter>
                <Layout>
                    <Routes>
                        <Route path="/" element={<HomePage />} />
                        <Route path="/search" element={<SearchPage />} />
                        <Route path="/manage" element={<ManagePage />} />
                        <Route path="*" element={<Navigate to="/" />} />
                    </Routes>
                </Layout>
            </HashRouter>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
